<!DOCTYPE html>
<meta charset="utf-8">
<title>Non-communicable Disease Funding (2010 - 2015)</title>
<link rel="stylesheet" href="slide.css">
<style>
.node rect {
  cursor: move;
  fill-opacity: .9;
  shape-rendering: crispEdges;
}

.node text {
  pointer-events: none;
  font-family: Verdana,Arial,sans-serif;
  font-size: 12px
  }

.link:hover {
  stroke-opacity: .5;
}

#instructions {
  font-family: Verdana,Arial,sans-serif;
  font-size: 12px
  }

h1 {
   font-family: Verdana,Arial,sans-serif; 
}
label {
    font-family: Verdana,Arial,sans-serif;  
    font-size: 12px
}
#credits
{
  font-size: 12px;
}
</style>
<body>

<h1 align='center'>Non-communicable Disease Funding (2010 - 2015)</h1>
<p id="instructions" align='center'><font color='grey' size="2px">Drag the blue circle to select a year</font></p>
<div align='center' id="slider"></div>
<br>
<div id="checkboxes" align="center">
<input type="checkbox" class="diseaseCheckbox" id="Cancer Checkbox" value="Cancer" checked><label for="Cancer Checkbox">Cancer</label>
&nbsp;
<input type="checkbox" class="diseaseCheckbox" id="Cardiovascular Checkbox" value="Cardiovascular" checked><label for="Cardiovascular Checkbox">Cardiovascular</label>
&nbsp;
<input type="checkbox" class="diseaseCheckbox" id="Chronic Respiratory Checkbox" value="Chronic Respiratory" checked><label for="Chronic Respiratory Checkbox">Chronic Respiratory</label>
&nbsp;
<input type="checkbox" class="diseaseCheckbox" id="Dental & Oral Health Checkbox" value="Dental & Oral Health" checked><label for="Dental & Oral Health Checkbox">Dental & Oral Health</label>
&nbsp;
<input type="checkbox" class="diseaseCheckbox" id="Diabetes Checkbox" value="Diabetes" checked><label for="Diabetes Checkbox">Diabetes</label>
&nbsp;
<input type="checkbox" class="diseaseCheckbox" id="Disability Checkbox" value="Disability" checked><label for="Disability Checkbox">Disability</label>
&nbsp;
<input type="checkbox" class="diseaseCheckbox" id="Genetic Checkbox" value="Genetic" checked><label for="Genetic Checkbox">Genetic</label>
<br>
<input type="checkbox" class="diseaseCheckbox" id="Hematological Checkbox" value="Hematological" checked><label for="Hematological Checkbox">Hematological</label>
&nbsp;
<input type="checkbox" class="diseaseCheckbox" id="Kidney Checkbox" value="Kidney" checked><label for="Kidney Checkbox">Kidney</label>
&nbsp;
<input type="checkbox" class="diseaseCheckbox" id="Mental Health Checkbox" value="Mental Health" checked><label for="Mental Health Checkbox">Mental Health</label>
&nbsp;
<input type="checkbox" class="diseaseCheckbox" id="Neurological Checkbox" value="Neurological" checked><label for="Neurological Checkbox">Neurological</label>
&nbsp;
<input type="checkbox" class="diseaseCheckbox" id="Other Checkbox" value="Other" checked><label for="Other Checkbox">Other</label>
&nbsp;
<input type="checkbox" class="diseaseCheckbox" id="Sensory Organs Checkbox" value="Sensory Organs" checked><label for="Sensory Organs Checkbox">Sensory Organs</label>
&nbsp;
<input type="checkbox" class="diseaseCheckbox" id="Substance Use Checkbox" value="Substance Use" checked><label for="Substance Use Checkbox">Substance Use</label>
&nbsp;
<input type="checkbox" class="diseaseCheckbox" id="Integrated Funding Checkbox" value="Integrated Funding"><label for="Integrated Funding Checkbox">Integrated Funding</label>
&nbsp;
<input type="checkbox" class="diseaseCheckbox" id="Multiple NCDs Checkbox" value="Multiple NCDs"><label for="Multiple NCDs Checkbox">Multiple NCDs</label>
&nbsp;

</div>
<p align = 'center' id="chart"></p>
<div id= "credits">
Credits: Code re-used from 
<a href="https://leanpub.com/D3-Tips-and-Tricks">Malcolm Maclean</a>
 | 
<a href="http://bl.ocks.org/d3noob/c9b90689c1438f57d649">d3noob</a>
 | 
<a href="https://github.com/d3/d3-sankey">Jason Davies, Mike Bostock</a>
 | 
<a href="http://sujeetsr.github.io/d3.slider/">Sujeet Sreenivasan</a>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js"></script>
<script src="slide.js"></script>
<script src="flows.js"></script>
<script>

var margin = {top: 10, right: 10, bottom: 10, left: 10};
var width = 1100 - margin.left - margin.right;
var height = 800 - margin.top - margin.bottom;

var formatNumber = d3.format(",.1f"),    // zero decimal places
    color = d3.scale.category20();

var svg = d3.select("#chart").append("svg")
   .attr("width", width + margin.left + margin.right)
   .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", 
              "translate(" + margin.left + "," + margin.top + ")");

var sankey = d3.sankey()
    .nodeWidth(36)
    .nodePadding(40)
    .size([width, height]);

var path = sankey.connect();

var formatter = d3.format(".0f");
            var tickFormatter = function(d) {
                return formatter(d);
            }
var slider = d3.slider().min(2010).max(2015).ticks(5).value(2010).tickFormat(tickFormatter).callback(filterByYear);
                d3.select('#slider').call(slider);

function filterByYear(sl){
  var year = sl;

function fundingFilter(list, query) {
  const fundingFilterKeys = Object.keys(query);
  return list.filter((item) => {
    return fundingFilterKeys.every(key =>   !!~query[key].indexOf(item[key]));
  });
}

// load data
d3.csv("ncd_data.csv", function(data)
  {
   function prepareData(data) {

    var graph = []
    var yearArray = [];
    data.forEach(function(row) {
      yearArray.push(row['Year'])
    })

    yearArray = Array.from(new Set(yearArray))

    var diseaseArray = [];
    data.forEach(function(row) {
      if(getSelectedDiseases().includes(row['Disease'])) {
              diseaseArray.push(row['Disease'])        
      }
    });

    diseaseArray = Array.from(new Set(diseaseArray));


    yearArray.forEach(function(year) {
     var graphElement = {};
     graphElement.year = year;
     graphElement.viz = {"nodes":[{"node":0,"name":"Total Funding"}],"links":[]};
     var nodeCount = 1;
     var linkCount = 1;
     diseaseArray.forEach(function(disease) {

          graphElement.viz.nodes.push({"node":nodeCount,"name":disease});
          query = {'Year':year,'Disease':disease}
          var funding = fundingFilter(data,query);
          funding = +funding[0]['Funding'];
          graphElement.viz.links.push({"source":0,"target":linkCount,"value":funding});
          nodeCount=nodeCount+1;
          linkCount=linkCount+1;
     });
     graph.push(graphElement)
   });
   return graph;
 }

function getSelectedDiseases() {
    var selectedDiseases = [];

  d3.selectAll(".diseaseCheckbox").each(function(box) {
    box = d3.select(this);
    if(box.property("checked")) {
      selectedDiseases.push(box.property("value"))
    }  
 });
 return selectedDiseases;
}

function drawViz() {

   var nodes = []
   var links = []

   var graph = prepareData(data)

   graph.forEach(function(item){
      if(year==item.year){
        nodes = item.viz.nodes
        links = item.viz.links
      }
    });

    sankey
      .nodes(nodes)
      .links(links)
      .layout(32);

  d3.selectAll(".node").remove();  
  d3.selectAll(".link").remove();  

  var linkColors = {"Cancer":"#8dd3c7",
                  "Cardiovascular":"#ffffb3",
                  "Chronic Respiratory":"#bebada",
                  "Dental & Oral Health":"#fb8072",
                  "Diabetes":"#80b1d3",
                  "Disability":"#fdb462",
                  "Genetic":"#b3de69",
                  "Hematological":"#fccde5",
                  "Kidney":"#d9d9d9",
                  "Mental Health":"#bc80bd",
                  "Neurological":"#fbb4ae",
                  "Other":"#ccebc5",
                  "Sensory Organs":"#ffed6f",
                  "Substance Use":"#decbe4",
                  "Integrated Funding":"#4daf4a",
                  "Multiple NCDs":"#fed9a6"
                }

//add diseases and funding flows
  var link = svg.append("g").selectAll(".link")
      .data(links)
    .enter().append("path")
      .attr("class", "link")
      .attr("d", path)
      .style("stroke-width", function(d) { return Math.max(1, d.dy); })
      .style("stroke", function(d) {
         return linkColors[d.target.name]
        })
      .style("fill", "none")
      .sort(function(a, b) { return b.dy - a.dy; });

  var node = svg.append("g").selectAll(".node")
      .data(nodes)
    .enter().append("g")
      .attr("class", "node")
      .attr("transform", function(d) { 
      return "translate(" + d.x + "," + d.y + ")"; })
 
//display disease names
  node.append("text")
      .attr("x", function(d){
        var xpos;
        if(d.node==0) {
          xpos = d.dx-45
        } 
        else {
          xpos= d.dx-20
        }
        return xpos})
      .attr("y", function(d) { return (d.dy / 2)-10; })
      .attr("dy", ".35em")
      .attr("font-weight","bold")
      .attr("transform", null)
      .text(function(d) { return d.name; })

//display disease funding
  node.append("text")
      .attr("x", function(d){
        var xpos;
        if(d.node==0) {
          xpos = d.dx-30
        } 
        else {
          xpos= d.dx-20
        }
        return xpos})
      .attr("y", function(d) { return (d.dy / 2)+10; })
      .text(function(d) { return "$"+formatNumber(d.value)+"M"; });

  }
  
d3.selectAll(".diseaseCheckbox")
  .on("change",drawViz)

drawViz();
 });

}

</script>
</body>
</html>